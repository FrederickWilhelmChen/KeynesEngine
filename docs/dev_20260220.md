# 经济模拟引擎现状与后续规划（MVP导向）

本文档基于 `README.md` 与 `description.md` 的设计原则，汇总当前系统的实现现状、已具备能力、缺口与下一阶段的详细补齐计划。目标是推进到“可以称为MVP”的经济循环引擎，并支持阶跃冲击实验（1000 Tick）。

---

## 一、当前系统现状（已实现）

### 1. 体系结构与并行约束
- Phase骨架已完成（9个阶段，单线程执行但并行形态保留）
- SoA扁平数组数据布局
- 局部缓冲写入 + 单线程归并结构
- 确定性哈希快照（Tick级输出用于一致性验证）

### 2. 全球市场外参（MVP雏形）
- 外部JSON提供全球市场基础价格与波动参数
- Tick级正态噪声（Box-Muller）
- 价格裁剪范围 0.5x ~ 2.0x

### 3. 国内价格机制（初版）
- 国家价格基于供需比生成
- 支持商品级“需求主导/供给主导”配置
- 支持 `priceSensitivity`（k）

### 4. CSV测试输出
- 可运行1000 Tick
- 输出 `globalPrice / nationalPrice / production / demand / inventory`
- 支持验证是否发散

---

## 二、当前系统的不足（无法称为MVP的原因）

1. 人口与劳动力缺失
   - 生产与消费不受人口/劳动力约束
   - 违背设计文档“人口优先”原则

2. 产业链缺失（投入产出关系）
   - 商品之间无上下游逻辑
   - 无法模拟能源→材料→工业品链条

3. 库存约束不足
   - 库存仅记录，不影响产出
   - 无库存上限与过剩抑制

4. 需求结构过于简化
   - 需求 = 生产 * 固定比例
   - 没有“人口消费 + 工业需求”拆分

5. 国内市场价格与库存关联不足
   - 价格仍以供需比为主，未体现库存的供给压力

6. 缺少阶跃冲击实验机制
   - 目前波动是周期+噪声，无法模拟外部突发冲击

7. 资源上限与替代机制缺失
   - 资源品供给未受禀赋约束
   - 缺少可替代品来缓冲资源短缺

8. 成本约束生产缺失
   - 价格低于成本时仍“照常生产”
   - 未体现“无利润则停产/降产”的现实逻辑

---

## 三、MVP必须补齐的 6 个核心项（确认版）

1. 人口与劳动力前置
2. 投入产出链（商品Inputs）
3. 库存上限与生产抑制
4. 需求结构：人口消费 + 工业需求
5. 价格引入库存因素
6. 阶跃冲击场景（如油价突升）
7. 资源禀赋上限（不可无限扩张）
8. 可替代能源/商品机制
9. 成本与价格联动（低于成本降产）

---

## 四、详细后续规划（可执行）

### 阶段 M1-A：人口与劳动力前置
目标：让生产和消费基于人口真实驱动
- 新增 `Population[province]`
- 新增 `Workforce[province]`（劳动力参与率）
- 生产能力受劳动力限制
- 消费需求由人口驱动

Phase影响：
- Phase1（Local Update）读取人口/劳动力
- 生产受劳动力约束
- 消费由人口需求生成

### 阶段 M1-B：产业链输入约束
目标：构建最小投入产出链
- 商品配置新增 `Inputs[]`
- 生产需要消耗输入库存
- 无输入则无法生产

实现要点：
- 生产计划阶段生成“期望产出”
- 实际产出 = min(产能约束, 劳动力约束, 输入库存约束)

### 阶段 M1-C：库存上限与生产抑制
目标：避免库存无限膨胀
- 每商品设置库存上限 `InventoryCap`
- 库存接近上限时降产
- 库存为负或不足时抬价

### 阶段 M1-D：需求结构拆分
目标：需求由两部分组成
1. 人口消费需求
2. 工业需求（作为生产输入）

### 阶段 M1-E：价格引入库存压力
目标：库存影响价格走势
- 库存高 → 价格下修
- 库存低 → 价格上修
- 价格由供需+库存共同驱动

### 阶段 M1-F：阶跃冲击场景
目标：验证收敛性
- 新增场景配置（如 `scenarios/oil_shock.json`）
- 设定 Tick 200 发生油价阶跃
- 观察1000 Tick收敛与反馈环

### 阶段 M1-G：资源禀赋上限
目标：资源型商品受地理与禀赋约束
- 新增 `ResourceCap[province, commodity]`
- 资源类商品产出 = min(产能, 劳动力, 资源上限)
- 不产资源的国家无法凭价格“变出资源”

### 阶段 M1-H：可替代品机制
目标：资源短缺时允许替代
- 新增替代矩阵（商品A可被B部分替代）
- 需求缺口可按权重分流至替代品
- 允许不同商品类别设置不同替代弹性

### 阶段 M1-I：成本与价格联动
目标：价格低于成本时降产/停产
- 单位成本 = 上游投入成本 + 劳动力成本 + 物流成本
- 若 `price < cost`：产出按比例缩减
- 结合库存与需求弹性形成可收敛反馈

---

## 五、测试与验证目标（MVP完成标准）

- 运行1000 Tick不崩溃
- 价格与库存不发散（无无限增长/震荡）
- 油价冲击后系统能形成新均衡或稳定退化
- 能输出完整CSV以便分析
- 资源短缺可被替代机制缓冲但不会违背禀赋约束
- 价格低于成本时产能收缩而非无限生产

---

## 六、建议的最小示例场景（Oil Shock）

商品链条：
- Oil（原材料，全球市场）
- Fuel（中间品，需要Oil）
- Goods（消费品，需要Fuel）

国家设置：
- 无产油国（Oil产量=0）
- 高度依赖进口Oil

冲击：
- Tick 200 将全球油价提升至 3x
- 观察 Fuel → Goods → 消费需求的传导

---

## 七、当前结论

目前系统是“可运行框架”，但缺乏现实经济循环的关键驱动因素。
MVP必须补齐人口、产业链、库存、需求结构与阶跃冲击机制，才能称为“可用的经济循环引擎”。

---

## 八、下一步确认

请确认以下3点，用于推进实施：

1. 人口模型粒度
   - 简化（总人口+劳动力）
   - 8阶层完整模型

2. 产业链表达方式
   - JSON定义每商品Inputs
   - 代码硬编码（仅用于MVP）

3. 阶跃冲击如何触发
   - JSON配置（推荐）
   - 代码硬触发

---

## 九、必须前置 vs 可扩展（MVP视角）

### 必须从一开始支持（后续接入代价巨大）
1. 预算约束与支付能力
2. 人口/劳动力前置
3. 产业链投入产出（Inputs）
4. 资源禀赋上限
5. 成本约束生产
6. 价格调整速度限制（粘性）
7. 需求刚性 vs 弹性分层

### 可后续插件/扩展接入
1. 货币名义/实际区分
2. 贸易平衡与外部账户
3. 汇率机制
4. 储蓄与投资闭环
5. 产能建设滞后
6. 完整物流网络

---

## 十、预算约束与阶层的前置结论

预算约束与人口数量、阶层划分强相关：
- 人口决定总体需求上限
- 阶层决定收入分布与消费结构
- 预算约束决定“可实现需求”而非“理想需求”

若不从一开始引入阶层，商品层级差异会被平均化，导致“所有人都消费同样结构”的失真。

结论：MVP阶段直接采用8阶层，但参数可简化（收入、消费权重、储蓄率）。

---

## 十一、8阶层最小参数表（MVP版）

说明：仅包含MVP必需参数，用于预算约束与消费结构分化。

参数定义：
- IncomeIndex: 收入相对指数（以1.0为社会平均）
- SavingsRate: 储蓄率（0-1）
- ConsumptionWeights: 消费权重（加总为1.0）
  - Necessities: 必需品
  - Services: 服务
  - Durable: 耐用品
  - Luxury: 奢侈品
  - Tech: 高科技品

| Class | IncomeIndex | SavingsRate | Necessities | Services | Durable | Luxury | Tech |
|------|-------------|-------------|-------------|----------|---------|--------|------|
| CapitalOwners | 4.0 | 0.35 | 0.15 | 0.20 | 0.20 | 0.30 | 0.15 |
| Managers | 2.2 | 0.20 | 0.25 | 0.25 | 0.25 | 0.15 | 0.10 |
| Professionals | 1.8 | 0.18 | 0.30 | 0.25 | 0.20 | 0.10 | 0.15 |
| SkilledWorkers | 1.2 | 0.12 | 0.45 | 0.25 | 0.15 | 0.05 | 0.10 |
| ServiceWorkers | 1.0 | 0.08 | 0.55 | 0.25 | 0.10 | 0.03 | 0.07 |
| UnskilledWorkers | 0.7 | 0.05 | 0.70 | 0.20 | 0.05 | 0.01 | 0.04 |
| Farmers | 0.8 | 0.10 | 0.65 | 0.20 | 0.08 | 0.02 | 0.05 |
| Unemployed | 0.3 | 0.00 | 0.85 | 0.12 | 0.02 | 0.00 | 0.01 |

备注：
- IncomeIndex 用于预算约束的初始简化。
- 消费权重用于把预算拆分为各商品层级需求。
- 可在MVP后根据数据与平衡性进一步细化。

---

## 十二、仍缺失但影响极大的关键点（需纳入初始设计轮）

以下内容不一定全部在MVP中实现，但必须在初始设计轮做结构性支持或预留接口。

### 1. 信用与支付延迟（最小形式）
- 现实交易存在账期与短期透支
- 若完全现金结算，会低估需求波动与市场滞后
- MVP可简化为“可透支额度 = 收入 * k”

### 2. 存量资本与折旧
- 产能应来自资本存量
- 缺少折旧会导致长期产能不变、系统失真

### 3. 价格调整速度差异
- 不同行业价格粘性不同（能源快、工资慢）
- 无差异会导致系统同步化与不现实振荡

### 4. 成本结构的最小定义
- 成本应至少包含：上游投入成本、工资成本、物流成本
- 否则“成本<价格不生产”的逻辑无法落地

### 5. 最小政府变量
- 即便不做完整财政，也需税率/转移支付占位
- 直接影响预算约束与消费能力

---

## 十三、物流成本当前状态

- 设计文档中已有物流系统完整设计
- 代码实现中尚未引入真实物流成本
- 当前价格与成本未包含物流项

建议：在M1引入“最小物流成本”占位（统一系数或按商品体积系数），后续替换为真实运输网络。

---

## 十四、政府与外部冲击的最小落地（参数化楔子）

本节将“产业政策 / 关税与贸易政策 / 外部供给操控”简化为可调参数，但强调必须挂在正确环节，且应允许随Tick变化。

### 1. 税制细化（保留环节参数）
- **原材料税率**、**中间品税率**、**消费品税率**、**高科技税率**
- MVP可用统一税率，但必须保留分环节参数以避免后续重构
- 税负作用于：
  - 生产端成本（生产税/能源税）
  - 消费端价格（消费税/增值税）

### 2. 产业政策（补贴/限制）
- 作为成本楔子或利润楔子
- 插入点：
  - **生产成本**（补贴降低成本，限制抬高成本）
  - **产能上限**（政策可调高/调低上限）

### 3. 关税与贸易政策
- 作为**进口价格楔子**
- 插入点：
  - **全球价格 -> 国内价格**转换
  - 国内价 = 全球价 * 汇率 * (1 + 关税率)

### 4. 外部供给操控（如OPEC减产/增产）
- 作为**全球供给冲击或全球价格冲击**
- 插入点：
  - 全球市场价格生成阶段（Phase4）
  - 或全球供给/供需比率阶段

### 5. 参数必须具备的特性
- 可随Tick变化（政策或事件驱动）
- 具备上限/下限，避免极端值导致发散
- 明确绑定环节，避免“全局万能乘子”
