# 现代全球政治经济模拟游戏
## 总体设计文档（v0.3 完整整合版）

---

## 一、项目愿景

构建一个现代背景（2022年起）的全球尺度政治经济模拟游戏，核心特征包括：

- **经济深度**：接近《维多利亚3》的复杂经济系统，包含完整的生产、消费、价格机制
- **物流真实**：细化的供应链和运输网络，体现不同运输方式的成本差异
- **政治系统**：议会制、选举系统、非固化的国策体系
- **强AI国家**：基于决策树的国家AI行为系统
- **单机体验**：暂不考虑多人联机
- **系统化设计**：高度系统化、非脚本化的核心机制

当前阶段目标：构建可收敛、可扩展、可并行的经济模拟核心，作为未来完整游戏的工程基础。

---

## 二、核心设计哲学

### 2.1 数据驱动

- 所有参数通过JSON配置，支持数据化设计
- 商品、产业链、政策均通过数据定义，不依赖硬编码逻辑树
- 支持Mod扩展和数据动态加载

### 2.2 强模块隔离

- 经济 ≠ 政治 ≠ AI ≠ 物流，严格分离
- 模块间通过定义良好的状态接口交互
- 禁止跨模块直接修改内部状态

### 2.3 并行友好优先

从第一天起设计为**阶段串行 + 阶段内并行**的架构，避免未来出现单核瓶颈（避免Paradox引擎的"一核有难八核围观"问题）。

### 2.4 确定性保证

- 固定线程池和固定数据分块
- 禁止锁竞争，使用无锁数据结构
- 保证相同输入产生相同输出（便于调试和回放）

---

## 三、系统总体架构

```
Game.Core
│
├── Economy（经济系统）
│     ├── Production（生产系统）
│     ├── Consumption（消费系统）
│     ├── MarketSolver（市场求解器）
│     ├── PriceModel（价格模型）
│     └── Trade（国际贸易）
│
├── Logistics（物流系统）
│     ├── TransportNetwork（运输网络）
│     ├── Shipping（海运）
│     ├── RiverTransport（内河航运）
│     ├── Rail（铁路）
│     ├── Road（公路）
│     └── CostPropagation（成本传播）
│
├── Population（人口系统）
│     ├── ClassSystem（阶层系统）
│     ├── IncomeDistribution（收入分配）
│     ├── Urbanization（城市化）
│     └── Migration（人口迁移）
│
├── Political（政治系统）
│     ├── Parliament（议会系统）
│     ├── Election（选举系统）
│     ├── PolicySystem（国策体系）
│     └── PartySystem（政党系统）
│
├── Government（政府系统）
│     ├── FiscalSystem（财政系统）
│     ├── CentralBank（央行系统）
│     ├── Currency（货币系统）
│     └── Inflation（通胀模型）
│
├── Stability（社会稳定系统）
│     ├── Satisfaction（满意度）
│     ├── Unrest（动乱指数）
│     └── Events（社会事件）
│
├── BlackMarket（黑市系统）[简化版]
│     ├── Smuggling（走私）
│     └── UndergroundEconomy（地下经济）
│
├── AI
│     ├── NationalStrategy（国家战略）
│     ├── EconomicEvaluation（经济评估）
│     └── PoliticalEvaluation（政治评估）
│
└── SimulationKernel（模拟内核）
      ├── TickPipeline（Tick流水线）
      ├── PhaseBarrier（阶段屏障）
      └── ThreadScheduler（线程调度器）
```

---

## 四、经济系统详细设计

### 4.1 商品模型

每个商品包含以下属性：

| 属性 | 说明 |
|------|------|
| 基础生产率 | 单位投入的基础产出 |
| 需求弹性 | 价格变化对需求的影响程度 |
| 供给弹性 | 价格变化对供给的影响程度 |
| 储存损耗率 | 每Tick的库存损耗比例 |
| 运输体积 | 影响物流成本 |
| 战略价值 | 影响AI决策优先级 |
| 保质期 | 部分商品会随时间贬值 |

**价格模型**：
```
Price = BasePrice × f(Supply / Demand) × (1 + TransportCost) × ExchangeRate

其中 f(x) 是S型函数，限制价格波动范围在[0.5×BasePrice, 2×BasePrice]
```

价格变化必须受限，避免系统发散。当供需比超出合理范围时，引入政策干预或市场调节机制。

### 4.2 市场结构

采用**国家级市场 + 全球市场**的双层结构：

1. **国家级市场**
   - 每个国家拥有独立的市场
   - 汇总国内所有省份的供需
   - 单线程价格求解
   - 固定迭代次数（如10次）

2. **全球市场**
   - 国家间贸易形成全球价格
   - 考虑运输成本和关税
   - 汇率影响实际交易成本

**市场求解是系统核心瓶颈**，必须保证：
- 严格确定性
- 禁止并行修改
- 固定归并顺序

### 4.3 产业链系统

构建完整的投入产出链：

```
原材料 → 初级加工 → 中间品 → 最终消费品
     ↓         ↓         ↓
   采矿业    制造业    消费品工业
   农业      化工业    服务业
```

每个产业节点：
- 输入：原材料/中间品需求
- 输出：产品供给
- 生产效率：受技术、基础设施、劳动力素质影响
- 利润：收入 - 原料成本 - 劳动力成本 - 物流成本

### 4.4 企业微观行为[延后实现]

当前MVP阶段不实现企业级微观模拟，但保留接口：

```csharp
interface IEnterpriseBehavior
{
    void MakeProductionDecision();
    void AdjustWorkforce();
    void InvestInCapacity();
}
```

当前使用宏观代理（Aggregate Agent）代替，后续可平滑迁移。

---

## 五、物流系统详细设计

### 5.1 运输方式成本结构

**成本特性（从低到高）**：
```
海运 << 内河航运 << 铁路 < 公路 < 空运
```

**具体成本比例**（参考现实数据，可调）：

| 运输方式 | 相对成本 | 速度 | 适用范围 |
|---------|---------|------|---------|
| 海运 | 1× | 慢 | 跨国、沿海 |
| 内河航运 | 2× | 慢 | 内陆河流沿线 |
| 铁路 | 5× | 中 | 内陆长途 |
| 公路 | 15× | 快 | 短途、末端配送 |
| 空运 | 100× | 极快 | 高价值、紧急 |

**关键设计**：海运和内河航运的**断崖式成本优势**
- 海运成本仅为铁路的1/5
- 内河航运成本为铁路的2/5
- 这将深刻影响产业布局（沿海/沿河工业带）

### 5.2 物流网络构建

**网络节点**：
- 港口（海运节点）
- 河港（内河航运节点）
- 铁路枢纽
- 公路节点
- 城市（消费/生产中心）

**边权重**：运输成本 = 基础成本 × 距离 × 地形系数 × 基础设施质量

### 5.3 成本传播机制

**预计算阶段**（低频执行，如每10 Tick）：
- 使用Dijkstra或A*算法计算最短路径
- 生成从每个生产地到每个消费地的最优路径
- 缓存路径和成本

**Tick内执行**（高频执行）：
- 读取缓存的路径成本
- 并行计算各省份的有效供给
- 有效供给 = 本地生产 + 进口 - 出口 - 物流损耗

### 5.4 物流对经济的影响

1. **市场有效供给**：物流成本影响商品实际可获得性
2. **地区价格差**：运输成本导致同一商品在不同地区价格差异
3. **产业利润**：高物流成本产业倾向于靠近原料地或消费市场
4. **比较优势**：低物流成本地区获得产业发展优势

---

## 六、人口与阶层系统

### 6.1 阶层细分

将人口细分为8个阶层，每个阶层有独特的经济行为和政治倾向：

| 阶层 | 主要收入来源 | 政治倾向 | 特征 |
|------|------------|---------|------|
| 资本所有者 | 资本收益、企业利润 | 保守/自由市场 | 高收入、低通胀敏感度 |
| 管理阶层 | 高薪、奖金 | 温和/实用主义 | 高消费、投资房产 |
| 专业技术阶层 | 技能工资 | 进步/技术导向 | 高教育、高流动性 |
| 技术工人 | 技能工资 | 劳工/福利主义 | 工会组织、薪资谈判 |
| 服务业从业者 | 服务工资 | 多元 | 灵活就业、受经济周期影响大 |
| 非熟练工 | 最低工资 | 激进/民粹 | 高通胀敏感度、易 mobilize |
| 农民 | 农产品收入 | 保守/本土主义 | 受农业政策影响大 |
| 失业人口 | 救济金/无收入 | 激进/不满 | 社会稳定风险源 |

### 6.2 阶层属性

每阶层包含以下属性：
- **收入**：平均工资水平
- **消费结构**：必需品/耐用品/奢侈品比例
- **储蓄率**：收入中用于储蓄的比例
- **政治倾向**：意识形态分布
- **通胀敏感度**：对物价上涨的容忍度
- **组织度**：罢工/抗议的能力

### 6.3 收入分配机制

```
总产出
├── 资本回报（资本家、投资者）
├── 劳动报酬（各工薪阶层）
├── 土地租金（地主、农民）
└── 税收（政府）
```

收入分配受以下因素影响：
- 劳动力市场供需
- 工会力量
- 最低工资政策
- 税收政策
- 通胀水平（实际收入）

### 6.4 城市化模型

**城市化动力**：
- 工业就业增长吸引农村人口
- 城市工资溢价
- 农业机械化释放劳动力

**城市化的经济效应**：
- 提升生产效率（集聚效应）
- 提升消费（城市生活方式）
- 提升政治活跃度（更容易组织集体行动）
- 基础设施压力（住房、交通、公共服务）

**城市化的人口效应**：
- 农村人口向城市迁移
- 改变阶层结构（农民→工人）
- 影响选举政治（城市选民 vs 农村选民）

---

## 七、政府与宏观系统

### 7.1 财政系统

**收入来源**：
- 个人所得税（累进税率）
- 企业所得税
- 增值税/消费税
- 关税
- 国有资产收益

**支出项目**：
- 政府消费（行政、国防）
- 转移支付（福利、养老金）
- 基础设施投资
- 债务利息
- 补贴（产业、农业）

**财政平衡**：
- 财政赤字 = 支出 - 收入
- 政府债务累积
- 债务上限和信用评级影响

### 7.2 央行系统

**货币政策工具**：

| 工具 | 作用机制 |
|------|---------|
| 基准利率 | 影响借贷成本和投资 |
| 存款准备金率 | 影响货币乘数 |
| 公开市场操作 | 直接调节货币供给 |
| 汇率干预 | 买卖外汇储备 |

**货币政策目标**：
- 价格稳定（通胀目标，如2%）
- 充分就业
- 经济增长
- 汇率稳定

### 7.3 通胀模型

**通胀来源**：
- 需求拉动型（总需求 > 总供给）
- 成本推动型（原材料、工资上涨）
- 货币型（货币超发）
- 输入型（进口通胀、汇率贬值）

**通胀的传导**：
```
货币供给增加 / 成本上涨
→ 商品价格上涨
→ 实际工资下降（名义工资粘性）
→ 各阶层满意度变化（取决于通胀敏感度）
→ 政治压力上升
→ 政策调整需求
```

### 7.4 外汇系统

**汇率制度**：
- 固定汇率制
- 浮动汇率制
- 管理浮动制

**汇率影响因素**：
- 贸易顺差/逆差
- 资本流动
- 利率差异
- 外汇储备
- 市场预期

**汇率的影响**：
- 出口竞争力
- 进口成本
- 外债负担
- 通胀输入

---

## 八、社会稳定与反馈系统

### 8.1 满意度模型

每个阶层都有**满意度**指标，受以下因素影响：
- **经济满意度**：收入、就业、物价
- **政治满意度**：政策取向、政府表现
- **社会满意度**：公平感、社会地位

### 8.2 通胀-稳定反馈环

```
通胀上升
    ↓
实际工资下降（名义工资粘性）
    ↓
工人阶层满意度下降
    ↓
罢工概率上升 / 政治支持率下降
    ↓
生产效率下降 / 政策调整压力
    ↓
供给减少 / 政治不确定性
    ↓
通胀进一步上升（恶性循环）
```

**打破恶性循环的机制**：
- 央行加息抑制通胀
- 财政紧缩
- 工资-物价管制（极端情况）
- 收入再分配政策

### 8.3 社会稳定度

**稳定度等级**：
- 稳定（>70%）：正常生产
- 轻微动荡（50-70%）：效率-5%
- 中度动荡（30-50%）：效率-15%，投资-20%
- 严重动荡（10-30%）：效率-30%，投资-50%，政治危机风险
- 崩溃（<10%）：政府倒台风险

**稳定度影响**：
- 生产效率
- 投资意愿
- 政策通过率
- 社会秩序事件概率

---

## 九、黑市系统[简化版]

### 9.1 必要性评估

**建议**：在MVP阶段实现**简化版黑市**，理由：
1. 增强现实感（任何管制经济都有黑市）
2. 提供政策失败的反馈（高税收/管制→黑市繁荣）
3. 不算太复杂，但能增加系统深度

### 9.2 简化模型设计

**触发条件**：
- 合法市场价格过高（税收/管制导致）
- 商品短缺（配给制）
- 外汇管制（汇率高估）

**黑市机制**：
- 黑市价格 = 合法市场价格 × (1 + 溢价系数)
- 黑市供给 = 走私量 + 盗窃/逃税商品
- 黑市需求 = 无法从合法市场满足的需求

**政策影响**：
- 打击力度影响黑市规模
- 执法成本需要考虑
- 腐败风险（执法人员受贿）

### 9.3 黑市的经济效应

- 减少政府税收
- 扭曲价格信号
- 降低管制政策效果
- 可能缓解短缺（双刃剑）

---

## 十、政治系统详细设计

### 10.1 议会系统

**议会类型**：
- 一院制 / 两院制
- 比例代表制 / 多数制 / 混合制

**议会功能**：
- 立法（政策制定）
- 预算审批
- 政府监督
- 不信任投票

**议席分布**：
基于选举结果和各政党得票率动态计算。

### 10.2 选举系统

**选举类型**：
1. **议会选举**
   - 选区制：每个选区选出代表
   - 比例制：按全国得票率分配议席
   - 混合制：部分选区 + 部分比例

2. **总统选举**（如适用）
   - 直接选举
   - 间接选举（选举人团）

**选区设计**：
- 根据人口分布划分选区
- 城市选区 vs 农村选区（不同政治倾向）
- 选区边界影响选举结果（ gerrymandering 可能性）

**投票行为**：
- 基于阶层利益的理性选择
- 意识形态偏好
- 政党认同
- 对现任政府政绩的评价

### 10.3 国策体系（非固化）

**设计原则**：
- 拒绝《钢铁雄心4》式的固化国策树
- 采用**条件触发 + 动态决策**的开放系统

**国策类型**：
- 经济政策（税收、产业、贸易）
- 社会政策（福利、教育、医疗）
- 外交政策（结盟、贸易协定、制裁）
- 政治改革（选举制度、权力分配）

**国策实施**：
- 需要议会支持（取决于议席分布）
- 受利益集团影响
- 有时限和成本
- 效果有延迟

**国家特色**：
- 不同国家有不同的政策选项（基于意识形态、历史、文化）
- 但不是固化的树状结构，而是参数化的偏好

### 10.4 政党系统

**政党定位**：
每个政党有意识形态坐标：
- 经济轴：左（平等/管制）— 右（自由/市场）
- 社会轴：保守 — 进步
- 民族主义轴：国际主义 — 民族主义

**政党支持基础**：
- 不同阶层的支持率不同
- 随经济和政治环境变化
- 政党可能改组或新兴

---

## 十一、AI系统设计

### 11.1 设计原则

- **决策树 + 权重评估**：基于当前状态做决策，不复制完整世界
- **无深度预测**：不进行多步未来模拟（避免计算爆炸）
- **读取上一Tick状态**：基于稳定的历史数据决策
- **可并行**：每个国家独立计算

### 11.2 决策层次

**1. 战略层（低频，如每12 Tick）**
- 确定国家发展目标（增长/稳定/霸权）
- 选择盟友和对手
- 长期产业政策

**2. 战术层（中频，如每4 Tick）**
- 经济政策调整
- 财政预算分配
- 贸易协定决策

**3. 操作层（高频，每Tick）**
- 市场干预（买卖储备）
- 短期政策微调
- 危机应对

### 11.3 决策评估函数

```csharp
class AIDecision
{
    float EconomicScore;      // 预期经济效果
    float PoliticalScore;     // 政治支持度影响
    float StabilityScore;     // 社会稳定影响
    float InternationalScore; // 国际关系影响
    float Cost;              // 实施成本
    
    float TotalScore => 
        w1*EconomicScore + 
        w2*PoliticalScore + 
        w3*StabilityScore + 
        w4*InternationalScore - 
        w5*Cost;
}
```

权重 w1-w5 根据国家特性（威权/民主、发展程度）调整。

### 11.4 AI决策约束

- 禁止修改主世界状态（只读）
- 只输出**决策意图**（如"提高税率5%"）
- 决策意图由SimulationKernel统一执行
- 确保AI决策不导致系统发散

---

## 十二、Tick执行架构

### 12.1 计算阶段划分

```
Tick Start
│
├─ Phase 1: 省份本地计算 (Parallel)
│   ├─ 生产计算（基于上一Tick价格）
│   ├─ 本地消费计算
│   └─ 人口自然增长
│
├─ Phase 2: 物流成本传播 (Parallel)
│   ├─ 计算各省份有效供给
│   └─ 计算物流成本加成
│
├─ Phase 3: 全局归并 (Single Thread)
│   ├─ 汇总全国供需
│   ├─ 汇总全球供需
│   └─ 更新市场状态
│
├─ Phase 4: 市场价格求解 (Single Thread)
│   ├─ 国家市场价格迭代求解
│   └─ 全球市场价格平衡
│
├─ Phase 5: 收入分配 (Parallel)
│   ├─ 计算各阶层收入
│   ├─ 计算实际收入（考虑通胀）
│   └─ 计算消费支出
│
├─ Phase 6: 政治系统更新 (Parallel)
│   ├─ 更新满意度
│   ├─ 计算社会稳定度
│   └─ 黑市活动计算
│
├─ Phase 7: 政府行为 (Parallel per Country)
│   ├─ 税收征收
│   ├─ 政策执行
│   ├─ 央行操作
│   └─ 财政预算执行
│
├─ Phase 8: AI决策 (Parallel per Country)
│   ├─ 读取当前状态
│   ├─ 评估决策选项
│   └─ 输出决策意图
│
└─ Phase 9: 决策执行 (Single Thread)
    ├─ 验证AI决策合法性
    ├─ 应用决策效果
    └─ 状态持久化

Tick End
```

### 12.2 人口和城市化优先级的理由

人口和城市化放在**Phase 1**（高优先级）的原因：

1. **基础性**：人口是所有经济活动的最终基础
2. **滞后性**：人口变化是慢变量，需要提前计算以影响当期经济
3. **连锁效应**：人口→劳动力→生产→收入→消费，是经济循环的起点
4. **城市化反馈**：城市化影响生产效率，需要在生产计算前确定

### 12.3 阶段屏障（Phase Barrier）

每个阶段结束时有**屏障同步**：
- 等待所有并行任务完成
- 确保数据一致性
- 才能进入下一阶段

---

## 十三、多线程并行设计

### 13.1 为什么Paradox引擎被批评"一核有难八核围观"

**根本原因**：
1. **单线程设计遗产**：Clauswitz引擎基于2000年代初的设计，当时多核不普及
2. **全局状态依赖**：国家间高度相互依赖，难以并行
3. **确定性需求**：需要精确 reproducible，锁机制复杂
4. **历史包袱**：大量代码难以重构为并行安全

**具体表现**：
- AI计算串行化
- 经济模拟单线程
- 只有渲染和IO使用多核
- 每天（Tick）的计算集中在单核

### 13.2 我们的并行策略

**核心原则**：**阶段串行 + 阶段内并行**

#### 13.2.1 固定线程池

- 根据CPU核心数创建固定线程池（如8线程）
- 固定数据分块（如每线程负责N个省份）
- 保证确定性：相同输入→相同分块→相同输出

#### 13.2.2 禁止锁（Lock-Free）

- Tick内不得使用lock/mutex
- 使用无锁数据结构（Lock-Free Queues）
- 使用原子操作（Interlocked/Atomic）
- 使用线程局部存储（Thread Local Storage）

#### 13.2.3 Map-Reduce模式

```
Map阶段（并行）：
  每个线程处理分配的省份
  计算结果写入线程局部缓冲区
  
Barrier同步

Reduce阶段（单线程）：
  主线程归并所有线程的结果
  更新全局状态
```

### 13.3 各模块并行性分析

| 模块 | 并行性 | 风险等级 | 策略 |
|------|--------|---------|------|
| 省份生产 | 高 | 低 | 完全并行，无共享状态 |
| 物流成本 | 高 | 中 | 路径预计算，Tick内只读 |
| 市场归并 | 低 | 高 | 单线程，必须确定性 |
| 价格求解 | 低 | 高 | 单线程，固定迭代 |
| 收入分配 | 高 | 低 | 完全并行 |
| 社会稳定 | 高 | 低 | 完全并行 |
| AI决策 | 中 | 高 | 每国家一任务，禁止写共享状态 |

### 13.4 数据布局优化

**SoA (Structure of Arrays) 而非 AoS (Array of Structures)**：

```csharp
// 推荐：SoA - 缓存友好，便于SIMD
class ProvinceData
{
    float[] production;    // [provinceCount]
    float[] consumption;   // [provinceCount]
    float[] population;    // [provinceCount]
}

// 不推荐：AoS - 缓存不友好
class Province
{
    float production;
    float consumption;
    float population;
}
Province[] provinces;
```

**连续内存**：
- 使用连续数组而非链表
- 使用索引而非指针
- 预分配内存，避免GC压力

### 13.5 潜在瓶颈和优化

**瓶颈1：市场求解（单线程）**
- 优化：固定低迭代次数（如5-10次）
- 优化：近似求解而非精确平衡
- 优化：分商品并行（如果商品间独立性高）

**瓶颈2：AI决策（复杂评估）**
- 优化：简化评估函数
- 优化：决策缓存（相似状态下复用决策）
- 优化：分层决策（战略层低频）

**瓶颈3：内存带宽**
- 优化：数据紧凑布局
- 优化：减少不必要的数据拷贝
- 优化：使用分层存储（热数据在L1/L2）

---

## 十四、技术选型

### 14.1 为什么选择C#

**优势**：

1. **开发效率**
   - 现代语言特性（LINQ、异步、模式匹配）
   - 丰富的标准库
   - Visual Studio/Rider的优秀IDE支持
   - 快速迭代，适合MVP验证

2. **性能**
   - .NET Core/.NET 5+ 性能接近C++
   - Span<T>和Memory<T>提供零拷贝操作
   - Value类型和Struct可堆栈分配
   - 可unsafe代码进行底层优化

3. **并行和并发**
   - Task Parallel Library (TPL) 成熟易用
   - Parallel.ForEach 简化并行循环
   - async/await 处理IO（如保存/加载）
   - Concurrent Collections 提供线程安全结构

4. **生态系统**
   - Unity（如果未来需要3D可视化）
   - ML.NET（如果未来需要机器学习AI）
   - 丰富的NuGet包（数学、数据结构）

5. **确定性**
   - 相比C++更容易控制浮点数精度
   - 托管内存减少内存问题导致的非确定性

**劣势**：
- GC暂停（但可用对象池缓解）
- 非托管互操作有开销（但本项目不需要）
- 相比C++对内存布局控制稍弱（但Span<T>已大幅改善）

### 14.2 替代方案评估

| 语言 | 优势 | 劣势 | 适合性 |
|------|------|------|--------|
| **C++** | 极致性能、精细内存控制 | 开发慢、易出错、构建复杂 | 高（但开发成本高） |
| **C#** | 平衡性能和生产力 | GC暂停 | **最高（推荐）** |
| **Rust** | 安全性、性能 | 学习曲线陡、生态较新 | 中高 |
| **Java** | 生态成熟 | 性能略低、GC更重 | 中 |
| **Python** | 开发极快 | 性能不足、GIL限制并行 | 低（仅原型） |

**结论**：C#是当前项目的**最优选择**，平衡了性能需求和开发效率。

### 14.3 技术栈建议

**核心框架**：
- **.NET 8/9** - 最新LTS版本，性能最优

**关键库**：
- **System.Numerics** - SIMD优化
- **System.Collections.Concurrent** - 并发集合
- **Microsoft.Extensions.ObjectPool** - 对象池减少GC

**数据结构**：
- 自定义SoA数据结构
- 无锁队列（ConcurrentQueue）
- 线程局部存储（ThreadLocal<T>）

**可选**：
- **Unity** - 如果需要3D地图可视化
- **ImGui.NET** - 调试UI
- **BenchmarkDotNet** - 性能测试

---

## 十五、MVP（最小可行产品）规划

### 15.1 MVP目标

验证核心假设：
1. 经济系统能否在AI决策下保持稳定（收敛）
2. 价格机制是否合理（不出现极端波动）
3. 通胀-社会稳定反馈环是否工作
4. 多线程架构是否可行

### 15.2 MVP范围

**包含**：
- 经济系统（生产、消费、市场）
- 物流系统（基础版本）
- 人口和阶层系统
- 简化的政治系统（满意度、稳定度）
- 简化的政府系统（税收、基础通胀）
- 基础AI（维持经济稳定的简单决策）
- 单核/多核版本

**不包含**：
- 战争系统（已移除）
- 企业微观行为（延后）
- 完整政治系统（选举、议会）
- 复杂AI（深度策略）
- 图形界面（命令行输出）

### 15.3 MVP里程碑

**阶段1：单线程核心（4-6周）**
- 基础数据结构（SoA）
- 省份-国家-全球市场三层结构
- 基础价格求解器
- 简单生产-消费循环
- 命令行输出CSV数据

**验证点**：
- 价格是否收敛
- 系统是否稳定（运行1000 Tick不崩溃）

**阶段2：人口与物流（3-4周）**
- 阶层系统
- 收入分配
- 基础物流成本
- 城市化模型

**验证点**：
- 阶层收入分布是否合理
- 物流是否影响产业布局

**阶段3：社会稳定（2-3周）**
- 满意度计算
- 通胀影响
- 稳定度反馈
- 简单事件

**验证点**：
- 通胀-稳定反馈环是否工作
- 系统能否自我调节

**阶段4：并行化（3-4周）**
- 阶段并行化
- 省份并行计算
- 性能测试

**验证点**：
- 多核加速比（理想4核3.5x+）
- 确定性保证（相同种子相同结果）

**阶段5：基础AI（3-4周）**
- 简单规则AI
- 基础决策树
- 经济稳定目标

**验证点**：
- AI能否维持经济基本稳定
- AI决策是否导致系统发散

**总时间**：15-21周（约4-5个月，1人全职）

### 15.4 成功标准

**技术成功**：
- 支持100+省份
- 支持20+商品
- 支持10+国家
- 1000 Tick运行时间 < 1分钟（4核）
- 价格方差 < 20%（收敛性）
- 崩溃率 < 1%

**设计成功**：
- 通胀率稳定在0-10%区间
- 失业率 < 15%
- GDP增长率 -5% ~ +10%
- 社会稳定度 > 30%（不频繁崩溃）

---

## 十六、系统架构一致性

### 16.1 平滑迁移策略

**目标**：前期经济建模可以平滑迁移到游戏工程中

**策略**：

1. **接口抽象**
   ```csharp
   interface IEconomicSimulation
   {
       void Initialize(WorldData data);
       void Tick();
       WorldState GetState();
   }
   ```
   - MVP核心实现此接口
   - 游戏引擎也基于此接口
   - 可无缝替换实现

2. **数据驱动**
   - 所有参数外置JSON
   - 核心代码无硬编码数值
   - 游戏设计可调参

3. **模块化设计**
   - 每个系统独立DLL/项目
   - 清晰边界和接口
   - 可独立测试和优化

4. **确定性保证**
   - 从MVP第一天起保证确定性
   - 便于调试和回放
   - 支持存档/读档

### 16.2 架构预留扩展点

**已预留**：
- 企业微观行为接口
- 战争系统接口（经济制裁、资源争夺）
- 金融市场接口（股票、债券）
- 复杂AI接口（机器学习）

**扩展路径**：
```
MVP核心 → 添加图形界面 → 添加完整政治系统 → 添加战争系统 → 完整游戏
```

---

## 十七、风险控制

### 17.1 技术风险

| 风险 | 可能性 | 影响 | 缓解措施 |
|------|--------|------|---------|
| 市场求解发散 | 中 | 高 | 限制价格波动范围，引入政策干预 |
| 多线程Bug | 中 | 高 | 严格阶段屏障，充分单元测试 |
| 性能不达标 | 低 | 中 | 早期性能测试，预留优化空间 |
| 内存爆炸 | 低 | 高 | 对象池，连续数组，定期Profiling |

### 17.2 设计风险

| 风险 | 可能性 | 影响 | 缓解措施 |
|------|--------|------|---------|
| 经济系统过于复杂 | 中 | 中 | MVP阶段简化，逐步添加 |
| AI行为不可控 | 中 | 高 | 限制AI决策范围，引入约束 |
| 游戏性不足 | 高 | 高 | 早期原型测试，迭代设计 |

### 17.3 工程原则

1. **禁止全局共享可写状态**
2. **禁止Tick内部递归系统调用**
3. **禁止浮点随机顺序计算**
4. **所有模块必须可单元测试**
5. **每个阶段必须有确定性输出**

---

## 十八、总结

### 18.1 项目定位

这是一个**高复杂度、系统化、数据驱动**的现代全球政治经济模拟游戏。

**核心创新点**：
- 真实物流系统（海运/内河的成本优势）
- 完整阶层政治经济模型
- 非固化的动态国策系统
- 从底层设计的多核并行架构

### 18.2 开发路径

```
现在 → MVP验证（4-5月） → 图形原型（2-3月） → 完整游戏（12-18月）
```

**当前重点**：
1. 搭建基础架构
2. 实现核心经济循环
3. 验证收敛性和稳定性
4. 建立并行化框架

### 18.3 成功关键

1. **克制**：MVP阶段严格控制范围，避免过早优化
2. **数据驱动**：所有设计可量化、可验证
3. **确定性**：从第一天保证可重现性
4. **并行思维**：每个设计都考虑多核执行
5. **模块化**：清晰边界，便于迭代

---

## 附录

### A. 术语表

- **Tick**：游戏的时间步进单位（如代表一天）
- **SoA**：Structure of Arrays，数组结构体
- **AoS**：Array of Structures，结构体数组
- **SIMD**：Single Instruction Multiple Data，单指令多数据
- **MVP**：Minimum Viable Product，最小可行产品

### B. 参考游戏

- **维多利亚3**：经济系统深度参考
- **钢铁雄心4**： military系统参考（已移除，但设计思想参考）
- **Europa Universalis IV**：政治系统参考
- **Cities: Skylines**：城市化模拟参考

### C. 技术参考

- **Clauswitz引擎分析**：了解Paradox引擎的局限
- **数据导向设计（DOD）**：Unity的ECS系统
- **Lock-Free编程**：C#并发最佳实践

---

*文档版本：v0.3*  
*最后更新：2026年*  
*作者：AI Assistant + User*
